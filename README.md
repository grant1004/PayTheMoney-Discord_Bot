# PayTheMoney Discord Bot 💰

一個功能豐富的 Discord 機器人，專為金錢借貸管理、AI 對話、天氣查詢和時間提醒而設計。

## ✨ 主要功能

### 🏦 債務管理系統
- **借貸記錄**: 記錄借款人、貸款人、金額、用途和日期
- **確認機制**: 債權人需確認收款，確保記錄準確性
- **查詢功能**: 查看未收到的欠款記錄
- **自動清理**: 每日自動清理已確認的債務記錄

### 🤖 AI 智能對話
- **Claude AI 整合**: 使用 Claude-4 Sonnet 模型提供智能回應
- **單次對話**: `/claude` 命令進行一次性問答
- **多輪對話**: `/chat` 命令支援有記憶的連續對話
- **網路搜尋**: 可選啟用 DuckDuckGo 搜尋增強回答品質
- **使用限制**: 每用戶每日 20 次對話限制
- **@ 回應**: 直接 @ 機器人即可觸發對話

### 🌦️ 天氣服務
- **台灣全覆蓋**: 支援台灣 22 個縣市的天氣查詢
- **詳細資訊**: 包含溫度、濕度、降雨機率、風速等完整天氣資訊
- **智能建議**: 根據天氣條件提供出行建議
- **即時更新**: 使用 Open-Meteo API 獲取最新天氣資料

### ⏰ 時間提醒系統
- **靈活設定**: 支援未來 7 天內的時間設定
- **提前提醒**: 可設定 5 分鐘到 24 小時的提前提醒
- **重複提醒**: 未確認的提醒每 10 分鐘重複一次
- **自動清理**: 超時未處理的提醒自動清除
- **台北時區**: 全部時間操作基於 Asia/Taipei 時區

## 🛠️ 技術架構

### 核心技術棧
- **Discord.js v14.17.3**: Discord API 整合，支援斜線命令、按鈕、模態框
- **PostgreSQL (pg v8.16.0)**: 資料庫操作與連接池管理
- **Anthropic AI SDK v0.27.3**: Claude AI 整合
- **duck-duck-scrape v2.2.7**: 網路搜尋功能
- **dotenv v16.4.7**: 環境變數管理

### 資料庫設計
```sql
CREATE TABLE debts (
    id TEXT PRIMARY KEY,
    debtor_id TEXT NOT NULL,     -- 借款人 Discord ID
    debtor_name TEXT NOT NULL,   -- 借款人名稱
    creditor_id TEXT NOT NULL,   -- 貸款人 Discord ID
    creditor_name TEXT NOT NULL, -- 貸款人名稱
    amount DECIMAL(10,2) NOT NULL, -- 金額
    purpose TEXT NOT NULL,       -- 用途
    date TEXT NOT NULL,         -- 日期
    confirmed BOOLEAN DEFAULT FALSE -- 確認狀態
);
```

### 記憶體存儲
- **對話歷史**: `Map<string, Array>` 儲存每頻道的對話記錄（最多 20 條）
- **使用限制**: `Map<string, number>` 追踪用戶每日 AI 使用次數
- **債務暫存**: `Map<string, Object>` 暫存債務輸入資料
- **排程管理**: `Map<string, Object>` 管理時間提醒設定

### 自動化功能
- **每日清理**: 每天 00:00 (台北時間) 自動清理已確認的債務記錄
- **定時檢查**: 每 30 秒檢查一次時間提醒
- **速率限制**: 搜尋功能具備冷卻時間防止過度使用

## 📋 指令列表

| 指令 | 描述 | 參數 |
|------|------|------|
| `/adddebt` | 新增借款記錄 | 借款人, 貸款人 |
| `/checkdebt` | 查詢欠款記錄 | 用戶名 |
| `/weather` | 查看天氣資訊 | 縣市名稱 (可選) |
| `/claude` | Claude AI 單次對話 | 訊息, 搜尋 (可選) |
| `/chat` | Claude AI 多輪對話 | 訊息, 搜尋 (可選) |
| `/clear-chat` | 清除對話歷史 | 無 |
| `/schedule` | 設定時間提醒 | 無 |

## ⚙️ 環境設定

### 必需的環境變數
```bash
DISCORD_TOKEN=你的Discord機器人Token
DATABASE_URL=PostgreSQL連接字串
ANTHROPIC_API_KEY=Claude AI API金鑰
NODE_ENV=production  # 生產環境啟用SSL資料庫連接
```

### 安裝與運行
```bash
# 安裝依賴
npm install

# 啟動機器人
npm start
```

## 🌍 支援的台灣縣市
台北市、新北市、桃園市、台中市、台南市、高雄市、新竹市、新竹縣、苗栗縣、彰化縣、南投縣、雲林縣、嘉義市、嘉義縣、屏東縣、宜蘭縣、花蓮縣、台東縣、澎湖縣、金門縣、連江縣、基隆市

## 🔒 安全特性
- **權限驗證**: 只有債權人可確認收款
- **資料驗證**: 嚴格的輸入驗證防止無效資料
- **錯誤處理**: 完整的錯誤捕獲與用戶友善的錯誤訊息
- **速率限制**: 防止 API 濫用的多重限制機制

## 📈 效能特色
- **連接池**: PostgreSQL 連接池提升資料庫效能
- **訊息分割**: 自動分割超長回應避免 Discord 限制
- **記憶體管理**: 自動清理過期的暫存資料
- **優雅關閉**: 程式結束時正確關閉資料庫連接

## 🤝 使用流程範例

### 債務記錄
1. 使用 `/adddebt` 選擇借款人和貸款人
2. 在彈出視窗中輸入金額和用途
3. 債權人點擊「確認已收到」按鈕完成記錄

### AI 對話
1. 使用 `/claude` 進行單次問答
2. 使用 `/chat` 開始多輪對話
3. 可選啟用搜尋功能獲得更準確回答
4. 直接 @ 機器人也可觸發對話

### 時間提醒
1. 使用 `/schedule` 開始設定
2. 依序選擇日期、時間和提前提醒時間
3. 提醒時間到達時點擊確認按鈕

這個機器人結合了實用的財務管理、智能對話、生活資訊和時間管理功能，是 Discord 伺服器的完美助手！
